# Aseprite-Palette-Swapper
This is an Aseprite plugin for converting sprites to/from the coloring used by the palette swap shaders we use in [Mr. Stretch](https://store.steampowered.com/app/2258130/Mr_Stretch_and_the_Stolen_Fortune/). However, the plugin may still be useful in other applications.

This plugin uses color palettes with multiple rows. All pixels with colors matching one row can be replaced with pixels from another. You can switch between palettes, or to and from one of the 13 "color channels" that are used by our Fast Palette Swap System (FPSS) written for Unity. Currently, the palette swap(s) is/are applied to all cels contained in the sprite. More fine-grained control may be added later if needed.

## Installation

A download can be found on the [Releases](https://github.com/Sambo3975/Aseprite-Palette-Swapper/releases) page. The plugin can be installed using one of the methods below.

### Method 1 (Windows/Mac)

1. Download the `.aseprite-extension` file.
2. Double-click the file to automatically install it to Aseprite.

### Method 2 (Windows/Mac/Linux)

1. Download the `.aseprite-extension` file.
2. In Aseprite, go to `Edit>Preferences`.
3. Select `Extensions` in the left panel.
4. Press `Add Extension` (located at the bottom left of the right panel)
5. Navigate to the downloaded file and select it to install.

Once the plugin has been installed, it can be accessed in Aseprite as a menu option at `Sprite>Palette Swap Tool`. It should appear directly below `Color Mode` on the dropdown. You must currently have a sprite open to use the plugin.

## Usage

When you select this plugin from the menu, you should see the following:

![Imgur](https://imgur.com/QTXBZQj.png)

An explanation of each field can be found below.

### Palette Path

This is the path where your palette files are located. Palette files are stored in `.png` files and arranged like the one below. Each color square is a single pixel; this is just zoomed in so you can see it clearly. The same color may appear on multiple rows. The same color may appear multiple times on the same row, but switching to a row that repeats a color cannot be reversed by a later palette swap.

![Imgur](https://imgur.com/YatPj1F.png)

When you click on this, a file dialog will appear for you to select an image in your palettes folder. Once selected, a list of palette files is generated by the plugin for the `From Palette` and `To Palette` fields.

This was intended to be a *folder* selection dialog, but Aseprite doesn't support those as of the time this was written.

The controls in the Palette Swap(s) section are not enabled until a Palette Path is selected.

### Check Palette Widths

If checked, you will be warned when trying to switch between palettes with different widths (different color counts per row). Switching in this way is supported, but it will have results that are possibly undesired, such as colors that were different becoming the same color, or not all colors on the new palette row being used. A warning will never appear when switching to or from a `<<color channel>>` palette, as these palettes are designed to work with palettes of any width.

### Close on Success

If checked, the dialog will be automatically closed after palettes are successfully swapped. If the palette swap fails for any reason, the dialog will stay open.

### From Palette

Name of the palette to switch from. Set this to `<<color channel>>` to switch from an FPSS color channel.

### From Row(s)

Row index(es) to switch from. Must be a single number or a space-separated list of numbers (e.g. `1 2 3`) that are in the range `[0 - (h-1)]` where `h` is the number of rows in `From Palette`. Inputs that don't meet these requirements will result in an error when trying to apply the palette swap(s).

### To Palette

Name of the palette to switch to. Set this to `<<color channel>>` to switch to an FPSS color channel. Set this to `<<match From Palette>>` to automatically use the same palette as `From Palette`.

__Performance note:__ Switching directly between rows in `<<color channel>>` is not recommended, as this is *extremely* slow. The `<<color channel>>` palette is has 255 colors per row, and the plugin will have to iterate over them all. This is avoided when switching between `<<color channel>>` and a normal, narrow palette, because only a number of iterations equal to the width of the narrower palette is needed.

### To Row(s)

Row index(es) to switch to. Must be a single number or a space-separated list of numbers (e.g. `1 2 3`) that are in the range `[0 - (h-1)]` where `h` is the number of rows in `To Palette`. Inputs that don't meet these requirements will result in an error when trying to apply the palette swap(s).

Additionally, `From Row(s)` and `To Row(s)` must have the same row count, or you will get an error when trying to apply the palette swap(s).

### Tolerance

Tolerance to use when finding colors to replace (0-255).

### Apply Palette Swap(s)

Once the fields are all set to your liking, press this button to apply the palette swaps. If there are any issues with your inputs, a dialog listing any errors will appear and the palette swap(s) will be cancelled. Otherwise, the palette swap(s) will begin. This can take a few seconds depending on how many cels are contained in your sprite and the number of rows being swapped.

Because this plugin must open multiple `.png` palette files stored on your machine to work, a security dialog like the one below may appear when the button is pressed.

![Imgur](https://imgur.com/IcBWBsj.png)

If you see this dialog, check `Give full trust to this script` and press the button on the left. The plugin will not make changes to any of your palette images and just loads them to get their color data. No images other than the selected palette images will be loaded. Always be sure to check unknown third-party scripts before executing them.
